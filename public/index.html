<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Subir archivo Excel</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #aaa; padding: 8px; text-align: left; }
    th { background: #eee; }
    button { margin-top: 10px; padding: 10px 15px; }
  </style>
</head>
<body>
  <h1>üì§ Subir archivo Excel (.xls o .xlsx)</h1>
  <form id="uploadForm">
    <input type="file" id="file" name="file" accept=".xls,.xlsx" required />
    <button type="submit">Subir y previsualizar</button>
   </form>

  <!-- AGREGAR ESTO: Barra de progreso -->
  <div id="progress-container" style="display: none; margin: 20px 0;">
    <div style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 8px; padding: 15px;">
      <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 8px;">
        <strong id="progress-status" style="color: #1976d2;">Procesando archivo...</strong>
        <span id="progress-percent" style="background: #1976d2; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">0%</span>
      </div>
      <div style="background: #e0e0e0; border-radius: 10px; height: 20px; overflow: hidden;">
        <div id="progress-bar" style="background: linear-gradient(45deg, #2196f3, #1976d2); height: 100%; width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: bold;"></div>
      </div>
      <small id="progress-message" style="color: #666; display: block; margin-top: 8px;">Iniciando procesamiento...</small>
    </div>
  </div>

  <div id="preview"></div>

  <script>
        const form = document.getElementById("uploadForm");
    const previewDiv = document.getElementById("preview");
    let previewData = [];

    // ========== AGREGAR ESTAS 3 FUNCIONES DE PROGRESO ==========
    let progressInterval;
    let confirmInterval;

    function updateProgress(percent, message = '', status = '') {
        const progressBar = document.getElementById('progress-bar');
        const progressPercent = document.getElementById('progress-percent');
        const progressMessage = document.getElementById('progress-message');
        const progressStatus = document.getElementById('progress-status');
        
        progressBar.style.width = percent + '%';
        progressPercent.textContent = Math.round(percent) + '%';
        
        if (message) {
            progressMessage.textContent = message;
        }
        
        if (status) {
            progressStatus.textContent = status;
        }
    }

     function toggleProgress(show = true) {
        const progressContainer = document.getElementById('progress-container');
        const fileInput = document.getElementById('file');
        const submitButton = form.querySelector('button');
        
        if (show) {
            progressContainer.style.display = 'block';
            submitButton.disabled = true;
            submitButton.textContent = 'Procesando...';
            submitButton.style.opacity = '0.6';
        } else {
            progressContainer.style.display = 'none';
            submitButton.disabled = false;
            submitButton.textContent = 'Subir y previsualizar';
            submitButton.style.opacity = '1';
            if (progressInterval) {
                clearInterval(progressInterval);
            }
            if (confirmInterval) {
                clearInterval(confirmInterval);
            }
        }
    }
    
    function startProgressSimulation() {
        let progress = 0;
        clearInterval(progressInterval);
        
        progressInterval = setInterval(() => {
            if (progress < 80) {
                progress += Math.random() * 15;
                if (progress > 80) progress = 80;
                
                if (progress < 30) {
                    updateProgress(progress, 'Subiendo archivo al servidor...', 'Subiendo...');
                } else if (progress < 60) {
                    updateProgress(progress, 'Procesando datos Excel...', 'Procesando...');
                } else {
                    updateProgress(progress, 'Generando vista previa...', 'Finalizando...');
                }
            }
        }, 400);
    }
    // ========== FIN DE FUNCIONES DE PROGRESO ==========

       form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const file = document.getElementById("file").files[0];
      
      if (!file) {
        alert("Por favor selecciona un archivo");
        return;
      }

      // 1. MOSTRAR BARRA DE PROGRESO
      toggleProgress(true);
      startProgressSimulation();

      try {
        const formData = new FormData();
        formData.append("file", file);

        // 2. HACER LA PETICI√ìN AL SERVIDOR
        const res = await fetch("/upload", { method: "POST", body: formData });
        const json = await res.json();
        
        // 3. ACTUALIZAR PROGRESO AL 100% CUANDO TERMINE
        updateProgress(100, '¬°Archivo procesado correctamente!', 'Completado');
        
        // 4. ESPERAR UN POCO PARA MOSTRAR EL 100%
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // 5. OCULTAR BARRA DE PROGRESO
        toggleProgress(false);
        
        previewData = json.preview || [];

        if (previewData.length === 0) {
          previewDiv.innerHTML = "<p>No se encontraron datos v√°lidos.</p>";
          return;
        }

        // 6. MOSTRAR TABLA CON VISTA PREVIA
        const headers = Object.keys(previewData[0]);
        const table = `
          <h3>Vista previa (${previewData.length} filas)</h3>
          <table>
            <thead><tr>${headers.map(h => `<th>${h}</th>`).join("")}</tr></thead>
            <tbody>
              ${previewData.slice(0, 10).map(row => `
                <tr>${headers.map(h => `<td>${row[h] || ""}</td>`).join("")}</tr>
              `).join("")}
            </tbody>
          </table>
          ${previewData.length > 10 ? `<p><em>Mostrando 10 de ${previewData.length} filas</em></p>` : ''}
          <button id="confirmBtn" style="margin-top: 15px; padding: 10px 20px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer;">‚úÖ Confirmar actualizaci√≥n</button>
        `;
        previewDiv.innerHTML = table;

        // 7. AGREGAR EVENTO AL BOT√ìN DE CONFIRMAR
               document.getElementById("confirmBtn").addEventListener("click", async () => {
          // 1. MOSTRAR PROGRESO PARA CONFIRMACI√ìN
          toggleProgress(true);
          updateProgress(0, 'Iniciando actualizaci√≥n en Jumpseller...', 'Actualizando productos');
          
          try {
            // 2. SIMULAR PROGRESO DURANTE LA ACTUALIZACI√ìN
            let confirmProgress = 0;
            confirmInterval = setInterval(() => {
              if (confirmProgress < 80) {
                confirmProgress += Math.random() * 10;
                if (confirmProgress > 80) confirmProgress = 80;
                
                if (confirmProgress < 40) {
                  updateProgress(confirmProgress, 'Actualizando precios...', 'Actualizando...');
                } else {
                  updateProgress(confirmProgress, 'Actualizando fechas...', 'Actualizando...');
                }
              }
            }, 300);

            // 3. HACER LA PETICI√ìN DE CONFIRMACI√ìN
            const res = await fetch("/confirm", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ data: previewData }),
            });
            
            // 4. DETENER SIMULACI√ìN Y MOSTRAR 100%
            clearInterval(confirmInterval);
            updateProgress(100, '¬°Actualizaci√≥n completada!', 'Completado');
            await new Promise(resolve => setTimeout(resolve, 800));
            
            // 5. OCULTAR BARRA DE PROGRESO
            toggleProgress(false);
            
            const msg = await res.json();
            alert(msg.message || "Actualizaci√≥n finalizada correctamente.");
            
          } catch (error) {
            // 6. MANEJAR ERRORES
            if (confirmInterval) clearInterval(confirmInterval);
            toggleProgress(false);
            console.error("Error en confirmaci√≥n:", error);
            alert("Error durante la actualizaci√≥n: " + error.message);
          }
        });
  </script>
</body>
</html>
